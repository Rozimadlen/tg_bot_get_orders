<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Bot Management Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .logo h1 {
            color: #667eea;
            font-size: 20px;
            margin-left: 10px;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            text-decoration: none;
            color: #555;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateX(5px);
        }

        .nav-icon {
            margin-right: 12px;
            font-size: 18px;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 28px;
            font-weight: 600;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.1), transparent);
            pointer-events: none;
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .lead-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .lead-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .lead-quality {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .quality-hot {
            background: #ff4757;
            color: white;
        }

        .quality-good {
            background: #ffa502;
            color: white;
        }

        .quality-normal {
            background: #2ed573;
            color: white;
        }

        .quality-low {
            background: #747d8c;
            color: white;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #2ed573;
            color: white;
        }

        .btn-warning {
            background: #ffa502;
            color: white;
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        .response-mode-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .mode-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .mode-card.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .pending-responses {
            max-height: 400px;
            overflow-y: auto;
        }

        .pending-item {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }

        .response-text {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            min-height: 80px;
            resize: vertical;
            width: 100%;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .keyword-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
        }

        .keyword-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-online {
            background: #2ed573;
        }

        .status-offline {
            background: #ff4757;
        }

        .status-warning {
            background: #ffa502;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #2ed573;
        }
        .notification.warning {
            background: #ffa502;
        }
        .notification.error {
            background: #ff4757;
        }
        .notification.warning {
            background: #ffa502;
        }
        .notification.info {
            background: #667eea;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <span style="font-size: 24px;">ü§ñ</span>
                <h1>TG Bot Control</h1>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" data-section="overview">
                        <span class="nav-icon">üìä</span>
                        Overview
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="monitoring">
                        <span class="nav-icon">üëÅÔ∏è</span>
                        Live Monitoring
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="responses">
                        <span class="nav-icon">ü§ñ</span>
                        Auto-Response
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="analytics">
                        <span class="nav-icon">üìà</span>
                        Analytics
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="keywords">
                        <span class="nav-icon">üîë</span>
                        Keywords
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="chats">
                        <span class="nav-icon">üí¨</span>
                        Chat Sources
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="exports">
                        <span class="nav-icon">üì•</span>
                        Exports
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Overview Section -->
            <div class="content-section active" id="overview">
                <div class="section-header">
                    <h2 class="section-title">Dashboard Overview</h2>
                    <button class="btn btn-primary" onclick="refreshData()">
                        üîÑ Refresh
                    </button>
                    <button class="btn btn-success" onclick="scanLeads()" style="margin-left: 10px;">
                        üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ª–∏–¥—ã
                    </button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalLeads">0</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –ª–∏–¥–æ–≤ —Å–µ–≥–æ–¥–Ω—è</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="hotLeads">0</div>
                        <div class="stat-label">üî• –ì–æ—Ä—è—á–∏–µ –ª–∏–¥—ã</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="responsesCount">0</div>
                        <div class="stat-label">–ò–ò –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="responseRate">0%</div>
                        <div class="stat-label">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –æ—Ç–≤–µ—Ç–æ–≤</div>
                    </div>
                </div>

                <div class="card">
                    <h3>üéØ –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞—Ç—É—Å–∞</h3>
                    <div style="margin-top: 15px;" id="systemStatus">
                        <!-- –°—Ç–∞—Ç—É—Å –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ API -->
                    </div>
                </div>

                <div class="card">
                    <h3>üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–∏–¥—ã</h3>
                    <div id="recentLeads">
                        <!-- –õ–∏–¥—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ API -->
                    </div>
                </div>
            </div>

            <!-- Live Monitoring Section -->
            <div class="content-section" id="monitoring">
                <div class="section-header">
                    <h2 class="section-title">Live Monitoring</h2>
                    <div>
                        <button class="btn btn-success" onclick="startMonitoring()" id="startBtn">
                            ‚ñ∂Ô∏è Start
                        </button>
                        <button class="btn btn-warning" onclick="pauseMonitoring()" id="pauseBtn">
                            ‚è∏Ô∏è Pause
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3>üî¥ –õ–∞–π–≤ –ª–µ–Ω—Ç–∞ –ª–∏–¥–æ–≤</h3>
                    <div id="liveFeed" style="max-height: 500px; overflow-y: auto;">
                        <p style="text-align: center; color: #666; padding: 20px;">
                            –ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ live –ª–µ–Ω—Ç—ã –ª–∏–¥–æ–≤
                        </p>
                    </div>
                </div>
            </div>

            <!-- Auto-Response Section -->
            <div class="content-section" id="responses">
                <div class="section-header">
                    <h2 class="section-title">Auto-Response Management</h2>
                </div>

                <div class="card">
                    <h3>üéõÔ∏è –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã</h3>
                    <div class="response-mode-selector">
                        <div class="mode-card selected" data-mode="ai">
                            <h4>ü§ñ –ò–ò –†–µ–∂–∏–º</h4>
                            <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç–≤–µ—Ç—ã —á–µ—Ä–µ–∑ Together.ai</p>
                        </div>
                        <div class="mode-card" data-mode="manual">
                            <h4>‚úã –†—É—á–Ω–æ–π —Ä–µ–∂–∏–º</h4>
                            <p>–í—Å–µ –æ—Ç–≤–µ—Ç—ã —Ç—Ä–µ–±—É—é—Ç —Ä—É—á–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</p>
                        </div>
                        <div class="mode-card" data-mode="hybrid">
                            <h4>‚ö° –ì–∏–±—Ä–∏–¥–Ω—ã–π</h4>
                            <p>–ò–ò –ø–∏—à–µ—Ç, –≤—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç–µ</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ò–ò</h3>
                    <div class="form-group">
                        <label class="form-label">–ò–ò –ü—Ä–æ–≤–∞–π–¥–µ—Ä:</label>
                        <select class="form-control" id="aiProvider">
                            <option value="together">Together.ai (DeepSeek)</option>
                            <option value="openai">OpenAI GPT-4</option>
                            <option value="anthropic">Anthropic Claude</option>
                            <option value="local">–õ–æ–∫–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç–≤–µ—Ç–∞ (–º–∏–Ω—É—Ç—ã):</label>
                        <input type="range" class="form-control" min="5" max="120" value="30" id="maxDelay">
                        <small id="delayValue">30 –º–∏–Ω—É—Ç</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="hotLeadsOnly"> –û—Ç–≤–µ—á–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞ –≥–æ—Ä—è—á–∏–µ –ª–∏–¥—ã
                        </label>
                    </div>
                    <button class="btn btn-primary" onclick="saveSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                </div>

                <div class="card">
                    <h3>‚è≥ –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã</h3>
                    <div class="pending-responses" id="pendingResponses">
                        <!-- –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ API -->
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div class="content-section" id="analytics">
                <div class="section-header">
                    <h2 class="section-title">Analytics & Reports</h2>
                </div>

                <div class="card">
                    <h3>üìä –ö–∞—á–µ—Å—Ç–≤–æ –ª–∏–¥–æ–≤ –∑–∞ –Ω–µ–¥–µ–ª—é</h3>
                    <div class="chart-container">
                        <canvas id="leadQualityChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3>üìà –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤</h3>
                    <div class="chart-container">
                        <canvas id="responseEfficiencyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Keywords Section -->
            <div class="content-section" id="keywords">
                <div class="section-header">
                    <h2 class="section-title">Keyword Configuration</h2>
                </div>

                <div class="card">
                    <h3>üîç –¢–µ—Å—Ç–µ—Ä –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤</h3>
                    <div class="form-group">
                        <label class="form-label">–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</label>
                        <textarea class="form-control" id="testMessage" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏...">–ò—â—É –≤–∏–¥–µ–æ–ø—Ä–æ–¥—é—Å–µ—Ä–∞ –¥–ª—è YouTube –∫–∞–Ω–∞–ª–∞. –ë—é–¥–∂–µ—Ç –µ—Å—Ç—å, —Å—Ä–æ–∫–∏ –≥–æ—Ä—è—Ç!</textarea>
                    </div>
                    <button class="btn btn-primary" onclick="testKeywords()">üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <div id="testResult" style="margin-top: 15px;"></div>
                </div>

                <div class="card">
                    <h3>üìù –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã–º–∏ —Ñ—Ä–∞–∑–∞–º–∏</h3>
                    <div class="form-group">
                        <label class="form-label">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Ñ—Ä–∞–∑—É:</label>
                        <input type="text" class="form-control" id="newKeyword" placeholder="–∏—â—É –≤–∏–¥–µ–æ–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞">
                        <button class="btn btn-success" onclick="addKeyword()" style="margin-top: 10px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                    <div class="keyword-list" id="keywordList">
                        <!-- –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ API -->
                    </div>
                </div>
            </div>

            <!-- Chat Sources Section -->
            <div class="content-section" id="chats">
                <div class="section-header">
                    <h2 class="section-title">Chat Source Management</h2>
                </div>

                <div class="card">
                    <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫</h3>
                    <div class="form-group">
                        <label class="form-label">ID –∏–ª–∏ @username —á–∞—Ç–∞:</label>
                        <input type="text" class="form-control" id="newChatSource" placeholder="@videomakerschat –∏–ª–∏ -1001234567890">
                        <button class="btn btn-success" onclick="addChatSource()" style="margin-top: 10px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å —á–∞—Ç</button>
                    </div>
                </div>

                <div class="card">
                    <h3>üìã –ê–∫—Ç–∏–≤–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏</h3>
                    <div id="chatSourcesList">
                        <!-- –ò—Å—Ç–æ—á–Ω–∏–∫–∏ —á–∞—Ç–æ–≤ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ API -->
                    </div>
                </div>
            </div>

            <!-- Exports Section -->
            <div class="content-section" id="exports">
                <div class="section-header">
                    <h2 class="section-title">Export & Reports</h2>
                </div>

                <div class="card">
                    <h3>üì• –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
                    <div class="form-group">
                        <label class="form-label">–ü–µ—Ä–∏–æ–¥:</label>
                        <select class="form-control" id="exportPeriod">
                            <option value="1">–°–µ–≥–æ–¥–Ω—è</option>
                            <option value="2">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 2 –¥–Ω—è</option>
                            <option value="7">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
                            <option value="30">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
                            <option value="90">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 90 –¥–Ω–µ–π</option>
                            <option value="365">–í–µ—Å—å –≥–æ–¥</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–§–æ—Ä–º–∞—Ç:</label>
                        <select class="form-control" id="exportFormat">
                            <option value="xlsx">Excel (.xlsx) - –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è</option>
                            <option value="csv">CSV (.csv) - –î–ª—è –∏–º–ø–æ—Ä—Ç–∞</option>
                            <option value="json">JSON (.json) - –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤</option>
                        </select>
                    </div>
                    <div style="background: #f0f7ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <p style="margin: 0; color: #0066cc;">
                            <strong>üí° –ß—Ç–æ –±—É–¥–µ—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ:</strong><br>
                            ‚Ä¢ –í—Å–µ –ª–∏–¥—ã –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥<br>
                            ‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞—á–µ—Å—Ç–≤–µ –∏ –æ—Ü–µ–Ω–∫–∞—Ö<br>
                            ‚Ä¢ –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–æ–≤<br>
                            ‚Ä¢ –°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–≤ Excel)
                        </p>
                    </div>
                    <button class="btn btn-primary" onclick="exportData()" style="width: 100%;">
                        üìä –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç
                    </button>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h3>üìà –ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                    <div id="quickStats">
                        <!-- –°—é–¥–∞ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±—ã—Å—Ç—Ä—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É -->
                    </div>
                    <button class="btn btn-success" onclick="generateQuickStats()" style="width: 100%;">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    </button>
                </div>
    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentSection = 'overview';
        let socket;
        let charts = {};

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
          setupEventListeners();     // –∫–ª–∏–∫–∏ –ø–æ –º–µ–Ω—é –∏ —Ç.–¥.
          initializeWebSocket();     // –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ socket.io
          loadInitialData();         // –ø–æ–¥–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å/–∫–ª—é—á–∏/—á–∞—Ç—ã/–≥—Ä–∞—Ñ–∏–∫–∏
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebSocket
        function initializeWebSocket() {
            socket = io();
            
            socket.on('connect', function() {
                showNotification('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É', 'success');
            });
            
            socket.on('disconnect', function() {
                showNotification('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ø–æ—Ç–µ—Ä—è–Ω–æ', 'error');
            });
            
            socket.on('status', function(data) {
                showNotification(data.message, data.type);
            });
            
            socket.on('monitoring_status', function(data) {
                updateMonitoringStatus(data);
            });
            
            socket.on('new_lead', function(data) {
                addNewLeadToFeed(data);
            });
            
            socket.on('lead_update', function(data) {
                console.log('–ù–æ–≤—ã–π –ª–∏–¥ –ø–æ–ª—É—á–µ–Ω:', data);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
                updateLeadCounters();
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ª–∏–¥–æ–≤
                addLeadToRecentList(data);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                showNotification(`–ù–æ–≤—ã–π –ª–∏–¥: ${data.quality_label}`, 'success');
            });

            socket.on('live_feed_update', function(data) {
                if (currentSection === 'monitoring') {
                    addNewLeadToFeed(data.data);
                }
            })
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            // –ù–∞–≤–∏–≥–∞—Ü–∏—è
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function() {
                    const section = this.dataset.section;
                    switchSection(section);
                    loadSectionData(section);
                });
            });

            // –†–µ–∂–∏–º –æ—Ç–≤–µ—Ç–æ–≤ - –ò–°–ü–†–ê–í–õ–ï–ù–û: –¥–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
            document.querySelectorAll('.mode-card').forEach(card => {
                card.addEventListener('click', function() {
                    document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    const mode = this.dataset.mode;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –≤ localStorage
                    localStorage.setItem('responseMode', mode);
                    
                    updateResponseMode(mode);
                });
            });

            // –°–ª–∞–π–¥–µ—Ä –∑–∞–¥–µ—Ä–∂–∫–∏
            document.getElementById('maxDelay').addEventListener('input', function() {
                document.getElementById('delayValue').textContent = this.value + ' –º–∏–Ω—É—Ç';
            });
        }


        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        function loadInitialData() {
            refreshData();
            loadKeywords();
            loadChatSources();
            loadPendingResponses();
            initializeCharts();
            restoreSettings(); // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É
        }
        
        function restoreSettings() {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∂–∏–º Auto-response
            const savedMode = localStorage.getItem('responseMode');
            if (savedMode) {
                document.querySelectorAll('.mode-card').forEach(card => {
                    card.classList.remove('selected');
                    if (card.dataset.mode === savedMode) {
                        card.classList.add('selected');
                    }
                });
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            const savedDelay = localStorage.getItem('maxDelay');
            if (savedDelay) {
                document.getElementById('maxDelay').value = savedDelay;
                document.getElementById('delayValue').textContent = savedDelay + ' –º–∏–Ω—É—Ç';
            }
            
            const savedProvider = localStorage.getItem('aiProvider');
            if (savedProvider) {
                document.getElementById('aiProvider').value = savedProvider;
            }
            
            const hotLeadsOnly = localStorage.getItem('hotLeadsOnly');
            if (hotLeadsOnly !== null) {
                document.getElementById('hotLeadsOnly').checked = hotLeadsOnly === 'true';
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏
        function switchSection(sectionName) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionName).classList.add('active');

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');

            currentSection = sectionName;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
        function loadSectionData(section) {
            switch(section) {
                case 'analytics':
                    loadAnalytics();
                    break;
                case 'responses':
                    loadPendingResponses();
                    break;
                case 'keywords':
                    loadKeywords();
                    break;
                case 'chats':
                    loadChatSources();
                    break;
            }
        }
        
        function updateLeadCounters() {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —á–µ—Ä–µ–∑ API
            fetch('/api/status')
                .then(response => response.json())
                .then(data => updateStats(data))
                .catch(error => console.error('Error updating stats:', error));
        }

        function addLeadToRecentList(leadData) {
            const container = document.getElementById('recentLeads');
            if (!container) return;
            
            const qualityClass = getQualityClass(leadData.quality_label);
            
            const leadElement = document.createElement('div');
            leadElement.className = 'lead-item';
            leadElement.style.animation = 'fadeIn 0.5s ease';
            leadElement.innerHTML = `
                <div>
                    <strong>${leadData.message_text.substring(0, 80)}...</strong><br>
                    <small>${leadData.chat_source} ‚Ä¢ —Ç–æ–ª—å–∫–æ —á—Ç–æ</small>
                </div>
                <span class="lead-quality ${qualityClass}">${leadData.quality_label}</span>
            `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
            container.insertBefore(leadElement, container.firstChild);
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            while (container.children.length > 5) {
                container.removeChild(container.lastChild);
            }
        }
    

        // API —Ñ—É–Ω–∫—Ü–∏–∏
        async function apiRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API request failed:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                throw error;
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        async function refreshData() {
            try {
                const status = await apiRequest('/api/status');
                updateStats(status);
                updateSystemStatus(status);
                
                const leads = await apiRequest('/api/leads?limit=5');
                updateRecentLeads(leads);
                
                showNotification('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
            } catch (error) {
                console.error('Failed to refresh data:', error);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStats(data) {
            document.getElementById('totalLeads').textContent = data.total_leads || 0;
            document.getElementById('hotLeads').textContent = data.hot_leads || 0;
            document.getElementById('responsesCount').textContent = data.responded || 0;
            const rate = (typeof data.response_rate === 'number') ? data.response_rate : 0;
            document.getElementById('responseRate').textContent = rate + '%';

        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏—Å—Ç–µ–º—ã
        function updateSystemStatus(data) {
            const statusHtml = `
                <div style="margin-bottom: 10px;">
                    <span class="status-indicator ${data.telegram_connected ? 'status-online' : 'status-offline'}"></span>
                    Telegram API: ${data.telegram_connected ? '–ü–æ–¥–∫–ª—é—á–µ–Ω' : '–û—Ç–∫–ª—é—á–µ–Ω'}
                </div>
                <div style="margin-bottom: 10px;">
                    <span class="status-indicator ${data.ai_connected ? 'status-online' : 'status-offline'}"></span>
                    Together.ai: ${data.ai_connected ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                </div>
                <div style="margin-bottom: 10px;">
                    <span class="status-indicator ${data.monitoring_active ? 'status-online' : 'status-warning'}"></span>
                    –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: ${data.monitoring_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}
                </div>
            `;
            document.getElementById('systemStatus').innerHTML = statusHtml;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ª–∏–¥–æ–≤
        function updateRecentLeads(leads) {
            if (!Array.isArray(leads)) { return; }
            const container = document.getElementById('recentLeads');
            if (leads.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">–õ–∏–¥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>';
                return;
            }

            const leadsHtml = leads.map(lead => {
                const qualityClass = getQualityClass(lead.quality_label);
                const timeAgo = getTimeAgo(lead.timestamp);
                
                return `
                    <div class="lead-item">
                        <div>
                            <strong>${lead.message_text.substring(0, 80)}...</strong><br>
                            <small>${lead.chat_source} ‚Ä¢ ${timeAgo}</small>
                        </div>
                        <span class="lead-quality ${qualityClass}">${lead.quality_label}</span>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = leadsHtml;
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ CSS –∫–ª–∞—Å—Å–∞ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞ –ª–∏–¥–∞
        function getQualityClass(quality) {
            if (quality.includes('–ì–û–†–Ø–ß–ò–ô')) return 'quality-hot';
            if (quality.includes('–•–û–†–û–®–ò–ô')) return 'quality-good';
            if (quality.includes('–û–ë–´–ß–ù–´–ô')) return 'quality-normal';
            return 'quality-low';
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ "–Ω–∞–∑–∞–¥"
        function getTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffMs = now - time;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            if (diffMins < 60) return `${diffMins} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours} —á –Ω–∞–∑–∞–¥`;
            
            const diffDays = Math.floor(diffHours / 24);
            return `${diffDays} –¥–Ω –Ω–∞–∑–∞–¥`;
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º
        function startMonitoring() {
            socket.emit('start_monitoring');
        }

        function pauseMonitoring() {
            socket.emit('stop_monitoring');
        }

        function updateMonitoringStatus(data) {
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (data.active) {
                startBtn.style.display = 'none';
                pauseBtn.style.display = 'inline-block';
            } else {
                startBtn.style.display = 'inline-block';
                pauseBtn.style.display = 'none';
            }
            
            showNotification(data.message, data.active ? 'success' : 'warning');
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ª–∏–¥–∞ –≤ live –ª–µ–Ω—Ç—É
        function addNewLeadToFeed(lead) {
            const liveFeed = document.getElementById('liveFeed');
            const qualityClass = getQualityClass(lead.quality_label);
            
            const feedItem = document.createElement('div');
            feedItem.className = 'lead-item';
            feedItem.style.animation = 'fadeIn 0.5s ease';
            feedItem.innerHTML = `
                <div>
                    <strong>${lead.message_text}</strong><br>
                    <small>${lead.chat_source} ‚Ä¢ —Ç–æ–ª—å–∫–æ —á—Ç–æ</small>
                </div>
                <span class="lead-quality ${qualityClass}">${lead.quality_label}</span>
            `;

            liveFeed.insertBefore(feedItem, liveFeed.firstChild);

            // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            while (liveFeed.children.length > 20) {
                liveFeed.removeChild(liveFeed.lastChild);
            }
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
        async function saveSettings() {
            const settings = {
                response_mode: document.querySelector('.mode-card.selected').dataset.mode,
                ai_provider: document.getElementById('aiProvider').value,
                max_delay: document.getElementById('maxDelay').value,
                hot_leads_only: document.getElementById('hotLeadsOnly').checked
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            localStorage.setItem('responseMode', settings.response_mode);
            localStorage.setItem('aiProvider', settings.ai_provider);
            localStorage.setItem('maxDelay', settings.max_delay);
            localStorage.setItem('hotLeadsOnly', settings.hot_leads_only);

            try {
                await apiRequest('/api/settings', {
                    method: 'POST',
                    body: JSON.stringify(settings)
                });
                showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
            }
        }


        function updateResponseMode(mode) {
            showNotification(`–†–µ–∂–∏–º –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${mode}`, 'info');
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã–º–∏ —Å–ª–æ–≤–∞–º–∏
        async function loadKeywords() {
            try {
                const keywords = await apiRequest('/api/keywords');
                updateKeywordsList(keywords);
            } catch (error) {
                console.error('Failed to load keywords:', error);
            }
        }

        function updateKeywordsList(keywords) {
            const container = document.getElementById('keywordList');
            
            if (keywords.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">–ö–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>';
                return;
            }

            const keywordsHtml = keywords.map(keyword => `
                <div class="keyword-item">
                    <span>${keyword}</span>
                    <button class="btn btn-danger" style="padding: 5px 10px;" onclick="removeKeyword('${keyword.replace(/'/g, "\\'")}')">‚ùå</button>
                </div>
            `).join('');
            
            container.innerHTML = keywordsHtml;
        }

        async function addKeyword() {
            const input = document.getElementById('newKeyword');
            const phrases = input.value.trim();
            
            if (!phrases) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã', 'error');
                return;
            }

            // –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ –∑–∞–ø—è—Ç—ã–º –∏ –æ—á–∏—â–∞–µ–º
            const phraseList = phrases.split(',').map(p => p.trim()).filter(p => p);
            
            let addedCount = 0;
            let errorCount = 0;

            for (const phrase of phraseList) {
                try {
                    const result = await apiRequest('/api/keywords', {
                        method: 'POST',
                        body: JSON.stringify({ phrase })
                    });
                    
                    if (result.status === 'success') {
                        addedCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    errorCount++;
                }
            }

            input.value = '';
            loadKeywords();
            
            if (addedCount > 0) {
                showNotification(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${addedCount} –∫–ª—é—á–µ–≤—ã—Ö —Ñ—Ä–∞–∑`, 'success');
            }
            if (errorCount > 0) {
                showNotification(`${errorCount} —Ñ—Ä–∞–∑ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞`, 'warning');
            }
        }
        

        async function removeKeyword(phrase) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∫–ª—é—á–µ–≤—É—é —Ñ—Ä–∞–∑—É "${phrase}"?`)) {
                return;
            }
            
            try {
                const response = await apiRequest(`/api/keywords?phrase=${encodeURIComponent(phrase)}`, {
                    method: 'DELETE'
                });
                
                if (response.status === 'success') {
                    loadKeywords(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
                    showNotification('–ö–ª—é—á–µ–≤–∞—è —Ñ—Ä–∞–∑–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
                } else {
                    showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ—Ä–∞–∑—ã', 'error');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–ª—é—á–µ–≤–æ–π —Ñ—Ä–∞–∑—ã', 'error');
            }
        }

        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
        async function testKeywords() {
            const message = document.getElementById('testMessage').value.trim();
            
            if (!message) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
                return;
            }

            try {
                const result = await apiRequest('/api/test-keyword', {
                    method: 'POST',
                    body: JSON.stringify({ message })
                });

                const testResult = document.getElementById('testResult');
                
                if (result.hit) {
                    testResult.innerHTML = `
                        <div style="padding: 15px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; color: #155724;">
                            <strong>‚úÖ –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ!</strong><br>
                            –ö–∞—á–µ—Å—Ç–≤–æ –ª–∏–¥–∞: ${result.quality.quality}<br>
                            –û—Ü–µ–Ω–∫–∞: ${result.quality.score} –±–∞–ª–ª–æ–≤<br>
                            ${result.quality.reasons.length > 0 ? '–ü—Ä–∏—á–∏–Ω—ã: ' + result.quality.reasons.join(', ') : ''}
                        </div>
                    `;
                } else {
                    testResult.innerHTML = `
                        <div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; color: #721c24;">
                            <strong>‚ùå –°–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</strong><br>
                            –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –±–æ—Ç–æ–º
                        </div>
                    `;
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤', 'error');
            }
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ —á–∞—Ç–æ–≤
        async function loadChatSources() {
            try {
                const sources = await apiRequest('/api/chat-sources');
                updateChatSourcesList(sources);
            } catch (error) {
                console.error('Failed to load chat sources:', error);
            }
        }

        function updateChatSourcesList(sources) {
            const container = document.getElementById('chatSourcesList');
            
            if (sources.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">–ò—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —á–∞—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>';
                return;
            }

            const sourcesHtml = sources.map(source => {
                const statusClass = source.active ? 'status-online' : 'status-offline';
                const lastLead = source.last_lead_time ? getTimeAgo(source.last_lead_time) : '–Ω–∏–∫–æ–≥–¥–∞';
                
                return `
                    <div class="lead-item">
                        <div>
                            <strong>${source.chat_name || source.chat_id}</strong><br>
                            <small>–ü–æ—Å–ª–µ–¥–Ω–∏–π –ª–∏–¥: ${lastLead} ‚Ä¢ –õ–∏–¥–æ–≤: ${source.leads_count}</small>
                        </div>
                        <div>
                            <span class="status-indicator ${statusClass}"></span>
                            <button class="btn btn-danger" style="padding: 5px 10px;" onclick="removeChatSource('${source.chat_id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = sourcesHtml;
        }

        async function addChatSource() {
            const input = document.getElementById('newChatSource');
            const chatId = input.value.trim();
            
            if (!chatId) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ ID –∏–ª–∏ username —á–∞—Ç–∞', 'error');
                return;
            }

            try {
                const result = await apiRequest('/api/chat-sources', {
                    method: 'POST',
                    body: JSON.stringify({
                        chat_id: chatId,
                        chat_name: chatId
                    })
                });
                
                if (result.status === 'success') {
                    input.value = '';
                    loadChatSources();
                    showNotification('–ò—Å—Ç–æ—á–Ω–∏–∫ —á–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —á–∞—Ç–∞', 'error');
            }
        }

        async function removeChatSource(chatId) {
            try {
                await apiRequest(`/api/chat-sources?chat_id=${encodeURIComponent(chatId)}`, {
                    method: 'DELETE'
                });
                loadChatSources();
                showNotification('–ò—Å—Ç–æ—á–Ω–∏–∫ —á–∞—Ç–∞ —É–¥–∞–ª–µ–Ω', 'info');
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —á–∞—Ç–∞', 'error');
            }
        }
        

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏
        async function loadPendingResponses() {
            try {
                const responses = await apiRequest('/api/pending-responses');
                updatePendingResponsesList(responses);
            } catch (error) {
                console.error('Failed to load pending responses:', error);
            }
        }

        function updatePendingResponsesList(responses) {
            const container = document.getElementById('pendingResponses');
            
            if (responses.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">–û—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –Ω–µ—Ç</p>';
                return;
            }

            const responsesHtml = responses.map(response => {
                const qualityClass = getQualityClass(response.quality_label);
                
                return `
                    <div class="pending-item" data-response-id="${response.id}">
                        <div><strong>–õ–∏–¥:</strong> "${response.lead_message.substring(0, 100)}..."</div>
                        <div><strong>–ò—Å—Ç–æ—á–Ω–∏–∫:</strong> ${response.chat_source}</div>
                        <div><strong>–ö–∞—á–µ—Å—Ç–≤–æ:</strong> <span class="lead-quality ${qualityClass}">${response.quality_label}</span></div>
                        <div><strong>–ò–ò –æ—Ç–≤–µ—Ç:</strong></div>
                        <textarea class="response-text" data-original="${response.ai_response}">${response.edited_response || response.ai_response}</textarea>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-success" onclick="approveResponse(${response.id})">‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                            <button class="btn btn-warning" onclick="editResponse(${response.id})">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="btn btn-danger" onclick="rejectResponse(${response.id})">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = responsesHtml;
        }

        async function approveResponse(responseId) {
            try {
                await apiRequest('/api/response-action', {
                    method: 'POST',
                    body: JSON.stringify({
                        response_id: responseId,
                        action: 'approve'
                    })
                });
                
                const item = document.querySelector(`[data-response-id="${responseId}"]`);
                if (item) {
                    item.style.background = '#d4edda';
                    item.querySelector('.btn-success').textContent = '‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';
                    item.querySelector('.btn-success').disabled = true;
                }
                
                showNotification('–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞', 'error');
            }
        }

        async function rejectResponse(responseId) {
            try {
                await apiRequest('/api/response-action', {
                    method: 'POST',
                    body: JSON.stringify({
                        response_id: responseId,
                        action: 'reject'
                    })
                });
                
                const item = document.querySelector(`[data-response-id="${responseId}"]`);
                if (item) {
                    item.style.background = '#f8d7da';
                    item.querySelector('.btn-danger').textContent = '‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ';
                    item.querySelector('.btn-danger').disabled = true;
                }
                
                showNotification('–û—Ç–≤–µ—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω', 'warning');
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞', 'error');
            }
        }

        async function editResponse(responseId) {
            const item = document.querySelector(`[data-response-id="${responseId}"]`);
            const textarea = item.querySelector('.response-text');
            
            textarea.focus();
            textarea.style.borderColor = '#667eea';
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
            const editedText = textarea.value;
            
            try {
                await apiRequest('/api/response-action', {
                    method: 'POST',
                    body: JSON.stringify({
                        response_id: responseId,
                        action: 'edit',
                        edited_text: editedText
                    })
                });
                
                showNotification('–û—Ç–≤–µ—Ç –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω', 'info');
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞', 'error');
            }
        }

        // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –≥—Ä–∞—Ñ–∏–∫–∏
        function initializeCharts() {
            // –ì—Ä–∞—Ñ–∏–∫ –∫–∞—á–µ—Å—Ç–≤–∞ –ª–∏–¥–æ–≤
            const leadQualityCtx = document.getElementById('leadQualityChart');
            if (leadQualityCtx) {
                charts.leadQuality = new Chart(leadQualityCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'],
                        datasets: [{
                            label: 'üî• –ì–æ—Ä—è—á–∏–µ',
                            data: [12, 19, 15, 25, 22, 18, 23],
                            borderColor: '#ff4757',
                            backgroundColor: 'rgba(255, 71, 87, 0.1)',
                            tension: 0.4
                        }, {
                            label: 'üü° –•–æ—Ä–æ—à–∏–µ',
                            data: [18, 25, 22, 30, 28, 25, 32],
                            borderColor: '#ffa502',
                            backgroundColor: 'rgba(255, 165, 2, 0.1)',
                            tension: 0.4
                        }, {
                            label: 'üü¢ –û–±—ã—á–Ω—ã–µ',
                            data: [25, 30, 28, 35, 32, 30, 38],
                            borderColor: '#2ed573',
                            backgroundColor: 'rgba(46, 213, 115, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // –ì—Ä–∞—Ñ–∏–∫ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–æ–≤
            const responseEfficiencyCtx = document.getElementById('responseEfficiencyChart');
            if (responseEfficiencyCtx) {
                charts.responseEfficiency = new Chart(responseEfficiencyCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['–û—Ç–≤–µ—á–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏', '–û—Ç–≤–µ—á–µ–Ω–æ –≤—Ä—É—á–Ω—É—é', '–ù–µ –æ—Ç–≤–µ—á–µ–Ω–æ'],
                        datasets: [{
                            data: [156, 23, 12],
                            backgroundColor: ['#667eea', '#2ed573', '#ff4757']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
        }

        async function loadAnalytics() {
            try {
                const analytics = await apiRequest('/api/analytics');
                updateCharts(analytics);
            } catch (error) {
                console.error('Failed to load analytics:', error);
            }
        }

        function updateCharts(analytics) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
            if (charts.leadQuality && analytics.weekly_leads) {
                // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞
                charts.leadQuality.update();
            }
            
            if (charts.responseEfficiency && analytics.response_efficiency) {
                charts.responseEfficiency.data.datasets[0].data = [
                    analytics.response_efficiency.responded,
                    0, // –†—É—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
                    analytics.response_efficiency.not_responded
                ];
                charts.responseEfficiency.update();
            }
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö

        async function exportData() {
            const period = document.getElementById('exportPeriod').value;
            const format = document.getElementById('exportFormat').value;
            
            try {
                showNotification('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞...', 'info');
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
                const response = await fetch(`/api/leads?limit=1000`);
                const leads = await response.json();
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–µ—Ä–∏–æ–¥—É
                const now = new Date();
                const daysAgo = new Date(now.getTime() - (period * 24 * 60 * 60 * 1000));
                
                const filteredLeads = leads.filter(lead => {
                    const leadDate = new Date(lead.timestamp);
                    return leadDate >= daysAgo;
                });
                
                if (filteredLeads.length === 0) {
                    showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥', 'warning');
                    return;
                }
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
                const exportData = filteredLeads.map(lead => ({
                    'ID': lead.id,
                    '–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è': lead.timestamp,
                    '–ò—Å—Ç–æ—á–Ω–∏–∫': lead.chat_source,
                    '–ò–º—è —á–∞—Ç–∞': lead.chat_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
                    '–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å': lead.sender_name,
                    '–°–æ–æ–±—â–µ–Ω–∏–µ': lead.message_text,
                    '–ö–∞—á–µ—Å—Ç–≤–æ': lead.quality_label,
                    '–û—Ü–µ–Ω–∫–∞': lead.quality_score,
                    '–ü—Ä–∏—á–∏–Ω—ã': Array.isArray(lead.quality_reasons) ? lead.quality_reasons.join(', ') : '',
                    '–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω': lead.responded ? '–î–∞' : '–ù–µ—Ç'
                }));
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞
                const dateStr = now.toISOString().split('T')[0];
                const periodName = period == 1 ? 'today' : `${period}days`;
                const filename = `leads_${periodName}_${dateStr}`;
                
                // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
                if (format === 'xlsx') {
                    exportToExcel(exportData, filename);
                } else if (format === 'csv') {
                    exportToCSV(exportData, filename);
                } else if (format === 'json') {
                    exportToJSON(exportData, filename);
                }
                
                showNotification(`‚úÖ –≠–∫—Å–ø–æ—Ä—Ç ${filteredLeads.length} –ª–∏–¥–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω!`, 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö', 'error');
            }
        }

        function exportToExcel(data, filename) {
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–Ω–∏–≥—É
            const wb = XLSX.utils.book_new();
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –ª–∏—Å—Ç
            const ws = XLSX.utils.json_to_sheet(data);
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–æ–∫
            const colWidths = [
                { wch: 8 },   // ID
                { wch: 20 },  // –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è
                { wch: 25 },  // –ò—Å—Ç–æ—á–Ω–∏–∫
                { wch: 25 },  // –ò–º—è —á–∞—Ç–∞
                { wch: 20 },  // –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å
                { wch: 50 },  // –°–æ–æ–±—â–µ–Ω–∏–µ
                { wch: 20 },  // –ö–∞—á–µ—Å—Ç–≤–æ
                { wch: 10 },  // –û—Ü–µ–Ω–∫–∞
                { wch: 40 },  // –ü—Ä–∏—á–∏–Ω—ã
                { wch: 15 }   // –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
            ];
            ws['!cols'] = colWidths;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ª–∏—Å—Ç –≤ –∫–Ω–∏–≥—É
            XLSX.utils.book_append_sheet(wb, ws, '–õ–∏–¥—ã');
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É –Ω–∞ –≤—Ç–æ—Ä–æ–π –ª–∏—Å—Ç
            const summary = [
                { '–ü–∞—Ä–∞–º–µ—Ç—Ä': '–í—Å–µ–≥–æ –ª–∏–¥–æ–≤', '–ó–Ω–∞—á–µ–Ω–∏–µ': data.length },
                { '–ü–∞—Ä–∞–º–µ—Ç—Ä': '–ì–æ—Ä—è—á–∏–µ –ª–∏–¥—ã', '–ó–Ω–∞—á–µ–Ω–∏–µ': data.filter(l => l['–ö–∞—á–µ—Å—Ç–≤–æ'].includes('–ì–û–†–Ø–ß–ò–ô')).length },
                { '–ü–∞—Ä–∞–º–µ—Ç—Ä': '–•–æ—Ä–æ—à–∏–µ –ª–∏–¥—ã', '–ó–Ω–∞—á–µ–Ω–∏–µ': data.filter(l => l['–ö–∞—á–µ—Å—Ç–≤–æ'].includes('–•–û–†–û–®–ò–ô')).length },
                { '–ü–∞—Ä–∞–º–µ—Ç—Ä': '–û–±—ã—á–Ω—ã–µ –ª–∏–¥—ã', '–ó–Ω–∞—á–µ–Ω–∏–µ': data.filter(l => l['–ö–∞—á–µ—Å—Ç–≤–æ'].includes('–û–ë–´–ß–ù–´–ô')).length },
                { '–ü–∞—Ä–∞–º–µ—Ç—Ä': '–ù–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ', '–ó–Ω–∞—á–µ–Ω–∏–µ': data.filter(l => l['–ö–∞—á–µ—Å—Ç–≤–æ'].includes('–ù–ò–ó–ö–û–ï')).length },
                { '–ü–∞—Ä–∞–º–µ—Ç—Ä': '–û—Ç–≤–µ—á–µ–Ω–æ', '–ó–Ω–∞—á–µ–Ω–∏–µ': data.filter(l => l['–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω'] === '–î–∞').length },
                { '–ü–∞—Ä–∞–º–µ—Ç—Ä': '–ë–µ–∑ –æ—Ç–≤–µ—Ç–∞', '–ó–Ω–∞—á–µ–Ω–∏–µ': data.filter(l => l['–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω'] === '–ù–µ—Ç').length }
            ];
            
            const ws2 = XLSX.utils.json_to_sheet(summary);
            ws2['!cols'] = [{ wch: 20 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, ws2, '–°–≤–æ–¥–∫–∞');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
            XLSX.writeFile(wb, `${filename}.xlsx`);
        }

        function exportToCSV(data, filename) {
            // –°–æ–∑–¥–∞–µ–º CSV –∫–æ–Ω—Ç–µ–Ω—Ç
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row =>
                    headers.map(header => {
                        const value = row[header];
                        // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∑–∞–ø—è—Ç—ã–µ –∏ –∫–∞–≤—ã—á–∫–∏
                        const escaped = String(value).replace(/"/g, '""');
                        return escaped.includes(',') || escaped.includes('"') || escaped.includes('\n')
                            ? `"${escaped}"`
                            : escaped;
                    }).join(',')
                )
            ].join('\n');
            
            // –°–æ–∑–¥–∞–µ–º Blob —Å BOM –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ Excel
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${filename}.csv`;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        function exportToJSON(data, filename) {
            // –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–∏–≤–æ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON
            const jsonContent = JSON.stringify(data, null, 2);
            
            // –°–æ–∑–¥–∞–µ–º Blob
            const blob = new Blob([jsonContent], { type: 'application/json' });
            
            // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${filename}.json`;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        setInterval(() => {
            if (currentSection === 'overview') {
                refreshData();
            }
        }, 30000); // –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥

        // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ä–∞–∑–¥–µ–ª–æ–≤
        function autoLoadSectionData() {
            setInterval(() => {
                switch(currentSection) {
                    case 'responses':
                        loadPendingResponses();
                        break;
                    case 'analytics':
                        loadAnalytics();
                        break;
                }
            }, 60000); // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        autoLoadSectionData();
        
        async function generateQuickStats() {
            try {
                const response = await fetch('/api/status');
                const stats = await response.json();
                
                document.getElementById('quickStats').innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <strong>–í—Å–µ–≥–æ –ª–∏–¥–æ–≤:</strong> ${stats.total_leads || 0}
                        </div>
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <strong>–ì–æ—Ä—è—á–∏—Ö –ª–∏–¥–æ–≤:</strong> ${stats.hot_leads || 0}
                        </div>
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <strong>–û—Ç–≤–µ—á–µ–Ω–æ:</strong> ${stats.responded || 0}
                        </div>
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <strong>–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–≤–µ—Ç–æ–≤:</strong> ${stats.response_rate || 0}%
                        </div>
                    </div>
                `;
                
                showNotification('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏', 'error');
            }
        }
        
        // –ü–æ–∏—Å–∫ –ª–∏–¥–æ–≤
        async function scanLeads() {
            try {
                showNotification('–ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ª–∏–¥–æ–≤...', 'info');
                
                const result = await apiRequest('/api/scan-leads', {
                    method: 'POST'
                });
                
                if (result.status === 'success') {
                    showNotification('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å —Å–µ—Ä–≤–µ—Ä–∞', 'success');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
                    setTimeout(() => {
                        refreshData();
                        loadKeywords();
                    }, 30000);
                } else {
                    showNotification('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏', 'error');
            }
        }
    </script>
</body>
</html>
