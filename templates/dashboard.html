<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Bot Management Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .logo h1 {
            color: #667eea;
            font-size: 20px;
            margin-left: 10px;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            text-decoration: none;
            color: #555;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateX(5px);
        }

        .nav-icon {
            margin-right: 12px;
            font-size: 18px;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 28px;
            font-weight: 600;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.1), transparent);
            pointer-events: none;
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .lead-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .lead-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .lead-quality {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .quality-hot {
            background: #ff4757;
            color: white;
        }

        .quality-good {
            background: #ffa502;
            color: white;
        }

        .quality-normal {
            background: #2ed573;
            color: white;
        }

        .quality-low {
            background: #747d8c;
            color: white;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #2ed573;
            color: white;
        }

        .btn-warning {
            background: #ffa502;
            color: white;
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        .response-mode-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .mode-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .mode-card.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .pending-responses {
            max-height: 400px;
            overflow-y: auto;
        }

        .pending-item {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }

        .response-text {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            min-height: 80px;
            resize: vertical;
            width: 100%;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .keyword-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
        }

        .keyword-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-online {
            background: #2ed573;
        }

        .status-offline {
            background: #ff4757;
        }

        .status-warning {
            background: #ffa502;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #2ed573;
        }
        .notification.warning {
            background: #ffa502;
        }
        .notification.error {
            background: #ff4757;
        }
        .notification.warning {
            background: #ffa502;
        }
        .notification.info {
            background: #667eea;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <span style="font-size: 24px;">🤖</span>
                <h1>TG Bot Control</h1>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" data-section="overview">
                        <span class="nav-icon">📊</span>
                        Overview
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="monitoring">
                        <span class="nav-icon">👁️</span>
                        Live Monitoring
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="responses">
                        <span class="nav-icon">🤖</span>
                        Auto-Response
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="analytics">
                        <span class="nav-icon">📈</span>
                        Analytics
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="keywords">
                        <span class="nav-icon">🔑</span>
                        Keywords
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="chats">
                        <span class="nav-icon">💬</span>
                        Chat Sources
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="exports">
                        <span class="nav-icon">📥</span>
                        Exports
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Overview Section -->
            <div class="content-section active" id="overview">
                <div class="section-header">
                    <h2 class="section-title">Dashboard Overview</h2>
                    <button class="btn btn-primary" onclick="refreshData()">
                        🔄 Refresh
                    </button>
                    <button class="btn btn-success" onclick="scanLeads()" style="margin-left: 10px;">
                        🔍 Сканировать лиды
                    </button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalLeads">0</div>
                        <div class="stat-label">Всего лидов сегодня</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="hotLeads">0</div>
                        <div class="stat-label">🔥 Горячие лиды</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="responsesCount">0</div>
                        <div class="stat-label">ИИ ответов отправлено</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="responseRate">0%</div>
                        <div class="stat-label">Коэффициент ответов</div>
                    </div>
                </div>

                <div class="card">
                    <h3>🎯 Система статуса</h3>
                    <div style="margin-top: 15px;" id="systemStatus">
                        <!-- Статус будет загружен через API -->
                    </div>
                </div>

                <div class="card">
                    <h3>📋 Последние лиды</h3>
                    <div id="recentLeads">
                        <!-- Лиды будут загружены через API -->
                    </div>
                </div>
            </div>

            <!-- Live Monitoring Section -->
            <div class="content-section" id="monitoring">
                <div class="section-header">
                    <h2 class="section-title">Live Monitoring</h2>
                    <div>
                        <button class="btn btn-success" onclick="startMonitoring()" id="startBtn">
                            ▶️ Start
                        </button>
                        <button class="btn btn-warning" onclick="pauseMonitoring()" id="pauseBtn">
                            ⏸️ Pause
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3>🔴 Лайв лента лидов</h3>
                    <div id="liveFeed" style="max-height: 500px; overflow-y: auto;">
                        <p style="text-align: center; color: #666; padding: 20px;">
                            Запустите мониторинг для просмотра live ленты лидов
                        </p>
                    </div>
                </div>
            </div>

            <!-- Auto-Response Section -->
            <div class="content-section" id="responses">
                <div class="section-header">
                    <h2 class="section-title">Auto-Response Management</h2>
                </div>

                <div class="card">
                    <h3>🎛️ Режим работы</h3>
                    <div class="response-mode-selector">
                        <div class="mode-card selected" data-mode="ai">
                            <h4>🤖 ИИ Режим</h4>
                            <p>Автоматические ответы через Together.ai</p>
                        </div>
                        <div class="mode-card" data-mode="manual">
                            <h4>✋ Ручной режим</h4>
                            <p>Все ответы требуют ручного подтверждения</p>
                        </div>
                        <div class="mode-card" data-mode="hybrid">
                            <h4>⚡ Гибридный</h4>
                            <p>ИИ пишет, вы редактируете</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>⚙️ Настройки ИИ</h3>
                    <div class="form-group">
                        <label class="form-label">ИИ Провайдер:</label>
                        <select class="form-control" id="aiProvider">
                            <option value="together">Together.ai (DeepSeek)</option>
                            <option value="openai">OpenAI GPT-4</option>
                            <option value="anthropic">Anthropic Claude</option>
                            <option value="local">Локальная модель</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Максимальная задержка ответа (минуты):</label>
                        <input type="range" class="form-control" min="5" max="120" value="30" id="maxDelay">
                        <small id="delayValue">30 минут</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="hotLeadsOnly"> Отвечать только на горячие лиды
                        </label>
                    </div>
                    <button class="btn btn-primary" onclick="saveSettings()">💾 Сохранить настройки</button>
                </div>

                <div class="card">
                    <h3>⏳ Отложенные ответы</h3>
                    <div class="pending-responses" id="pendingResponses">
                        <!-- Отложенные ответы будут загружены через API -->
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div class="content-section" id="analytics">
                <div class="section-header">
                    <h2 class="section-title">Analytics & Reports</h2>
                </div>

                <div class="card">
                    <h3>📊 Качество лидов за неделю</h3>
                    <div class="chart-container">
                        <canvas id="leadQualityChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3>📈 Эффективность ответов</h3>
                    <div class="chart-container">
                        <canvas id="responseEfficiencyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Keywords Section -->
            <div class="content-section" id="keywords">
                <div class="section-header">
                    <h2 class="section-title">Keyword Configuration</h2>
                </div>

                <div class="card">
                    <h3>🔍 Тестер ключевых слов</h3>
                    <div class="form-group">
                        <label class="form-label">Тестовое сообщение:</label>
                        <textarea class="form-control" id="testMessage" placeholder="Введите сообщение для проверки...">Ищу видеопродюсера для YouTube канала. Бюджет есть, сроки горят!</textarea>
                    </div>
                    <button class="btn btn-primary" onclick="testKeywords()">🧪 Тестировать</button>
                    <div id="testResult" style="margin-top: 15px;"></div>
                </div>

                <div class="card">
                    <h3>📝 Управление ключевыми фразами</h3>
                    <div class="form-group">
                        <label class="form-label">Добавить новую фразу:</label>
                        <input type="text" class="form-control" id="newKeyword" placeholder="ищу видеооператора">
                        <button class="btn btn-success" onclick="addKeyword()" style="margin-top: 10px;">➕ Добавить</button>
                    </div>
                    <div class="keyword-list" id="keywordList">
                        <!-- Ключевые слова будут загружены через API -->
                    </div>
                </div>
            </div>

            <!-- Chat Sources Section -->
            <div class="content-section" id="chats">
                <div class="section-header">
                    <h2 class="section-title">Chat Source Management</h2>
                </div>

                <div class="card">
                    <h3>➕ Добавить новый источник</h3>
                    <div class="form-group">
                        <label class="form-label">ID или @username чата:</label>
                        <input type="text" class="form-control" id="newChatSource" placeholder="@videomakerschat или -1001234567890">
                        <button class="btn btn-success" onclick="addChatSource()" style="margin-top: 10px;">➕ Добавить чат</button>
                    </div>
                </div>

                <div class="card">
                    <h3>📋 Активные источники</h3>
                    <div id="chatSourcesList">
                        <!-- Источники чатов будут загружены через API -->
                    </div>
                </div>
            </div>

            <!-- Exports Section -->
            <div class="content-section" id="exports">
                <div class="section-header">
                    <h2 class="section-title">Export & Reports</h2>
                </div>

                <div class="card">
                    <h3>📥 Экспорт данных</h3>
                    <div class="form-group">
                        <label class="form-label">Период:</label>
                        <select class="form-control" id="exportPeriod">
                            <option value="1">Сегодня</option>
                            <option value="2">Последние 2 дня</option>
                            <option value="7">Последние 7 дней</option>
                            <option value="30">Последние 30 дней</option>
                            <option value="90">Последние 90 дней</option>
                            <option value="365">Весь год</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Формат:</label>
                        <select class="form-control" id="exportFormat">
                            <option value="xlsx">Excel (.xlsx) - Рекомендуется</option>
                            <option value="csv">CSV (.csv) - Для импорта</option>
                            <option value="json">JSON (.json) - Для разработчиков</option>
                        </select>
                    </div>
                    <div style="background: #f0f7ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <p style="margin: 0; color: #0066cc;">
                            <strong>💡 Что будет экспортировано:</strong><br>
                            • Все лиды за выбранный период<br>
                            • Информация о качестве и оценках<br>
                            • Статус ответов<br>
                            • Сводная статистика (в Excel)
                        </p>
                    </div>
                    <button class="btn btn-primary" onclick="exportData()" style="width: 100%;">
                        📊 Скачать отчет
                    </button>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h3>📈 Быстрая статистика</h3>
                    <div id="quickStats">
                        <!-- Сюда можно добавить быструю статистику -->
                    </div>
                    <button class="btn btn-success" onclick="generateQuickStats()" style="width: 100%;">
                        🔄 Обновить статистику
                    </button>
                </div>
    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // Глобальные переменные
        let currentSection = 'overview';
        let socket;
        let charts = {};

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', () => {
          setupEventListeners();     // клики по меню и т.д.
          initializeWebSocket();     // подключение socket.io
          loadInitialData();         // подгружаем статус/ключи/чаты/графики
        });

        // Инициализация WebSocket
        function initializeWebSocket() {
            socket = io();
            
            socket.on('connect', function() {
                showNotification('Подключено к серверу', 'success');
            });
            
            socket.on('disconnect', function() {
                showNotification('Соединение с сервером потеряно', 'error');
            });
            
            socket.on('status', function(data) {
                showNotification(data.message, data.type);
            });
            
            socket.on('monitoring_status', function(data) {
                updateMonitoringStatus(data);
            });
            
            socket.on('new_lead', function(data) {
                addNewLeadToFeed(data);
            });
            
            socket.on('lead_update', function(data) {
                console.log('Новый лид получен:', data);
                
                // Обновляем счетчики
                updateLeadCounters();
                
                // Добавляем в список последних лидов
                addLeadToRecentList(data);
                
                // Показываем уведомление
                showNotification(`Новый лид: ${data.quality_label}`, 'success');
            });

            socket.on('live_feed_update', function(data) {
                if (currentSection === 'monitoring') {
                    addNewLeadToFeed(data.data);
                }
            })
        }

        // Настройка обработчиков событий
        function setupEventListeners() {
            // Навигация
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function() {
                    const section = this.dataset.section;
                    switchSection(section);
                    loadSectionData(section);
                });
            });

            // Режим ответов - ИСПРАВЛЕНО: добавлено сохранение в localStorage
            document.querySelectorAll('.mode-card').forEach(card => {
                card.addEventListener('click', function() {
                    document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    const mode = this.dataset.mode;
                    
                    // Сохраняем выбор в localStorage
                    localStorage.setItem('responseMode', mode);
                    
                    updateResponseMode(mode);
                });
            });

            // Слайдер задержки
            document.getElementById('maxDelay').addEventListener('input', function() {
                document.getElementById('delayValue').textContent = this.value + ' минут';
            });
        }


        // Загрузка начальных данных
        function loadInitialData() {
            refreshData();
            loadKeywords();
            loadChatSources();
            loadPendingResponses();
            initializeCharts();
            restoreSettings(); // Добавьте эту строку
        }
        
        function restoreSettings() {
            // Восстанавливаем режим Auto-response
            const savedMode = localStorage.getItem('responseMode');
            if (savedMode) {
                document.querySelectorAll('.mode-card').forEach(card => {
                    card.classList.remove('selected');
                    if (card.dataset.mode === savedMode) {
                        card.classList.add('selected');
                    }
                });
            }
            
            // Восстанавливаем другие настройки
            const savedDelay = localStorage.getItem('maxDelay');
            if (savedDelay) {
                document.getElementById('maxDelay').value = savedDelay;
                document.getElementById('delayValue').textContent = savedDelay + ' минут';
            }
            
            const savedProvider = localStorage.getItem('aiProvider');
            if (savedProvider) {
                document.getElementById('aiProvider').value = savedProvider;
            }
            
            const hotLeadsOnly = localStorage.getItem('hotLeadsOnly');
            if (hotLeadsOnly !== null) {
                document.getElementById('hotLeadsOnly').checked = hotLeadsOnly === 'true';
            }
        }

        // Переключение между разделами
        function switchSection(sectionName) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionName).classList.add('active');

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');

            currentSection = sectionName;
        }

        // Загрузка данных для конкретного раздела
        function loadSectionData(section) {
            switch(section) {
                case 'analytics':
                    loadAnalytics();
                    break;
                case 'responses':
                    loadPendingResponses();
                    break;
                case 'keywords':
                    loadKeywords();
                    break;
                case 'chats':
                    loadChatSources();
                    break;
            }
        }
        
        function updateLeadCounters() {
            // Обновляем статистику через API
            fetch('/api/status')
                .then(response => response.json())
                .then(data => updateStats(data))
                .catch(error => console.error('Error updating stats:', error));
        }

        function addLeadToRecentList(leadData) {
            const container = document.getElementById('recentLeads');
            if (!container) return;
            
            const qualityClass = getQualityClass(leadData.quality_label);
            
            const leadElement = document.createElement('div');
            leadElement.className = 'lead-item';
            leadElement.style.animation = 'fadeIn 0.5s ease';
            leadElement.innerHTML = `
                <div>
                    <strong>${leadData.message_text.substring(0, 80)}...</strong><br>
                    <small>${leadData.chat_source} • только что</small>
                </div>
                <span class="lead-quality ${qualityClass}">${leadData.quality_label}</span>
            `;
        
        // Добавляем в начало списка
            container.insertBefore(leadElement, container.firstChild);
            
            // Ограничиваем количество элементов
            while (container.children.length > 5) {
                container.removeChild(container.lastChild);
            }
        }
    

        // API функции
        async function apiRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API request failed:', error);
                showNotification('Ошибка соединения с сервером', 'error');
                throw error;
            }
        }

        // Обновление данных
        async function refreshData() {
            try {
                const status = await apiRequest('/api/status');
                updateStats(status);
                updateSystemStatus(status);
                
                const leads = await apiRequest('/api/leads?limit=5');
                updateRecentLeads(leads);
                
                showNotification('Данные обновлены', 'success');
            } catch (error) {
                console.error('Failed to refresh data:', error);
            }
        }

        // Обновление статистики
        function updateStats(data) {
            document.getElementById('totalLeads').textContent = data.total_leads || 0;
            document.getElementById('hotLeads').textContent = data.hot_leads || 0;
            document.getElementById('responsesCount').textContent = data.responded || 0;
            const rate = (typeof data.response_rate === 'number') ? data.response_rate : 0;
            document.getElementById('responseRate').textContent = rate + '%';

        }

        // Обновление статуса системы
        function updateSystemStatus(data) {
            const statusHtml = `
                <div style="margin-bottom: 10px;">
                    <span class="status-indicator ${data.telegram_connected ? 'status-online' : 'status-offline'}"></span>
                    Telegram API: ${data.telegram_connected ? 'Подключен' : 'Отключен'}
                </div>
                <div style="margin-bottom: 10px;">
                    <span class="status-indicator ${data.ai_connected ? 'status-online' : 'status-offline'}"></span>
                    Together.ai: ${data.ai_connected ? 'Активен' : 'Неактивен'}
                </div>
                <div style="margin-bottom: 10px;">
                    <span class="status-indicator ${data.monitoring_active ? 'status-online' : 'status-warning'}"></span>
                    Мониторинг: ${data.monitoring_active ? 'Активен' : 'Остановлен'}
                </div>
            `;
            document.getElementById('systemStatus').innerHTML = statusHtml;
        }

        // Обновление последних лидов
        function updateRecentLeads(leads) {
            if (!Array.isArray(leads)) { return; }
            const container = document.getElementById('recentLeads');
            if (leads.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Лидов пока нет</p>';
                return;
            }

            const leadsHtml = leads.map(lead => {
                const qualityClass = getQualityClass(lead.quality_label);
                const timeAgo = getTimeAgo(lead.timestamp);
                
                return `
                    <div class="lead-item">
                        <div>
                            <strong>${lead.message_text.substring(0, 80)}...</strong><br>
                            <small>${lead.chat_source} • ${timeAgo}</small>
                        </div>
                        <span class="lead-quality ${qualityClass}">${lead.quality_label}</span>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = leadsHtml;
        }

        // Получение CSS класса для качества лида
        function getQualityClass(quality) {
            if (quality.includes('ГОРЯЧИЙ')) return 'quality-hot';
            if (quality.includes('ХОРОШИЙ')) return 'quality-good';
            if (quality.includes('ОБЫЧНЫЙ')) return 'quality-normal';
            return 'quality-low';
        }

        // Получение времени "назад"
        function getTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffMs = now - time;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'только что';
            if (diffMins < 60) return `${diffMins} мин назад`;
            
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours} ч назад`;
            
            const diffDays = Math.floor(diffHours / 24);
            return `${diffDays} дн назад`;
        }

        // Управление мониторингом
        function startMonitoring() {
            socket.emit('start_monitoring');
        }

        function pauseMonitoring() {
            socket.emit('stop_monitoring');
        }

        function updateMonitoringStatus(data) {
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (data.active) {
                startBtn.style.display = 'none';
                pauseBtn.style.display = 'inline-block';
            } else {
                startBtn.style.display = 'inline-block';
                pauseBtn.style.display = 'none';
            }
            
            showNotification(data.message, data.active ? 'success' : 'warning');
        }

        // Добавление нового лида в live ленту
        function addNewLeadToFeed(lead) {
            const liveFeed = document.getElementById('liveFeed');
            const qualityClass = getQualityClass(lead.quality_label);
            
            const feedItem = document.createElement('div');
            feedItem.className = 'lead-item';
            feedItem.style.animation = 'fadeIn 0.5s ease';
            feedItem.innerHTML = `
                <div>
                    <strong>${lead.message_text}</strong><br>
                    <small>${lead.chat_source} • только что</small>
                </div>
                <span class="lead-quality ${qualityClass}">${lead.quality_label}</span>
            `;

            liveFeed.insertBefore(feedItem, liveFeed.firstChild);

            // Оставляем только последние 20 элементов
            while (liveFeed.children.length > 20) {
                liveFeed.removeChild(liveFeed.lastChild);
            }
        }

        // Управление настройками
        async function saveSettings() {
            const settings = {
                response_mode: document.querySelector('.mode-card.selected').dataset.mode,
                ai_provider: document.getElementById('aiProvider').value,
                max_delay: document.getElementById('maxDelay').value,
                hot_leads_only: document.getElementById('hotLeadsOnly').checked
            };
            
            // Сохраняем в localStorage
            localStorage.setItem('responseMode', settings.response_mode);
            localStorage.setItem('aiProvider', settings.ai_provider);
            localStorage.setItem('maxDelay', settings.max_delay);
            localStorage.setItem('hotLeadsOnly', settings.hot_leads_only);

            try {
                await apiRequest('/api/settings', {
                    method: 'POST',
                    body: JSON.stringify(settings)
                });
                showNotification('Настройки сохранены', 'success');
            } catch (error) {
                showNotification('Ошибка сохранения настроек', 'error');
            }
        }


        function updateResponseMode(mode) {
            showNotification(`Режим изменен на: ${mode}`, 'info');
        }

        // Управление ключевыми словами
        async function loadKeywords() {
            try {
                const keywords = await apiRequest('/api/keywords');
                updateKeywordsList(keywords);
            } catch (error) {
                console.error('Failed to load keywords:', error);
            }
        }

        function updateKeywordsList(keywords) {
            const container = document.getElementById('keywordList');
            
            if (keywords.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Ключевых слов пока нет</p>';
                return;
            }

            const keywordsHtml = keywords.map(keyword => `
                <div class="keyword-item">
                    <span>${keyword}</span>
                    <button class="btn btn-danger" style="padding: 5px 10px;" onclick="removeKeyword('${keyword.replace(/'/g, "\\'")}')">❌</button>
                </div>
            `).join('');
            
            container.innerHTML = keywordsHtml;
        }

        async function addKeyword() {
            const input = document.getElementById('newKeyword');
            const phrases = input.value.trim();
            
            if (!phrases) {
                showNotification('Введите ключевые фразы', 'error');
                return;
            }

            // Разделяем по запятым и очищаем
            const phraseList = phrases.split(',').map(p => p.trim()).filter(p => p);
            
            let addedCount = 0;
            let errorCount = 0;

            for (const phrase of phraseList) {
                try {
                    const result = await apiRequest('/api/keywords', {
                        method: 'POST',
                        body: JSON.stringify({ phrase })
                    });
                    
                    if (result.status === 'success') {
                        addedCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    errorCount++;
                }
            }

            input.value = '';
            loadKeywords();
            
            if (addedCount > 0) {
                showNotification(`Добавлено ${addedCount} ключевых фраз`, 'success');
            }
            if (errorCount > 0) {
                showNotification(`${errorCount} фраз уже существуют или ошибка`, 'warning');
            }
        }
        

        async function removeKeyword(phrase) {
            if (!confirm(`Удалить ключевую фразу "${phrase}"?`)) {
                return;
            }
            
            try {
                const response = await apiRequest(`/api/keywords?phrase=${encodeURIComponent(phrase)}`, {
                    method: 'DELETE'
                });
                
                if (response.status === 'success') {
                    loadKeywords(); // Перезагружаем список
                    showNotification('Ключевая фраза удалена', 'success');
                } else {
                    showNotification('Ошибка удаления фразы', 'error');
                }
            } catch (error) {
                showNotification('Ошибка удаления ключевой фразы', 'error');
            }
        }

        // Тестирование ключевых слов
        async function testKeywords() {
            const message = document.getElementById('testMessage').value.trim();
            
            if (!message) {
                showNotification('Введите сообщение для тестирования', 'error');
                return;
            }

            try {
                const result = await apiRequest('/api/test-keyword', {
                    method: 'POST',
                    body: JSON.stringify({ message })
                });

                const testResult = document.getElementById('testResult');
                
                if (result.hit) {
                    testResult.innerHTML = `
                        <div style="padding: 15px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; color: #155724;">
                            <strong>✅ Совпадение найдено!</strong><br>
                            Качество лида: ${result.quality.quality}<br>
                            Оценка: ${result.quality.score} баллов<br>
                            ${result.quality.reasons.length > 0 ? 'Причины: ' + result.quality.reasons.join(', ') : ''}
                        </div>
                    `;
                } else {
                    testResult.innerHTML = `
                        <div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; color: #721c24;">
                            <strong>❌ Совпадений не найдено</strong><br>
                            Это сообщение не будет обработано ботом
                        </div>
                    `;
                }
            } catch (error) {
                showNotification('Ошибка тестирования ключевых слов', 'error');
            }
        }

        // Управление источниками чатов
        async function loadChatSources() {
            try {
                const sources = await apiRequest('/api/chat-sources');
                updateChatSourcesList(sources);
            } catch (error) {
                console.error('Failed to load chat sources:', error);
            }
        }

        function updateChatSourcesList(sources) {
            const container = document.getElementById('chatSourcesList');
            
            if (sources.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Источников чатов пока нет</p>';
                return;
            }

            const sourcesHtml = sources.map(source => {
                const statusClass = source.active ? 'status-online' : 'status-offline';
                const lastLead = source.last_lead_time ? getTimeAgo(source.last_lead_time) : 'никогда';
                
                return `
                    <div class="lead-item">
                        <div>
                            <strong>${source.chat_name || source.chat_id}</strong><br>
                            <small>Последний лид: ${lastLead} • Лидов: ${source.leads_count}</small>
                        </div>
                        <div>
                            <span class="status-indicator ${statusClass}"></span>
                            <button class="btn btn-danger" style="padding: 5px 10px;" onclick="removeChatSource('${source.chat_id}')">🗑️</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = sourcesHtml;
        }

        async function addChatSource() {
            const input = document.getElementById('newChatSource');
            const chatId = input.value.trim();
            
            if (!chatId) {
                showNotification('Введите ID или username чата', 'error');
                return;
            }

            try {
                const result = await apiRequest('/api/chat-sources', {
                    method: 'POST',
                    body: JSON.stringify({
                        chat_id: chatId,
                        chat_name: chatId
                    })
                });
                
                if (result.status === 'success') {
                    input.value = '';
                    loadChatSources();
                    showNotification('Источник чата добавлен', 'success');
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                showNotification('Ошибка добавления источника чата', 'error');
            }
        }

        async function removeChatSource(chatId) {
            try {
                await apiRequest(`/api/chat-sources?chat_id=${encodeURIComponent(chatId)}`, {
                    method: 'DELETE'
                });
                loadChatSources();
                showNotification('Источник чата удален', 'info');
            } catch (error) {
                showNotification('Ошибка удаления источника чата', 'error');
            }
        }
        

        // Управление отложенными ответами
        async function loadPendingResponses() {
            try {
                const responses = await apiRequest('/api/pending-responses');
                updatePendingResponsesList(responses);
            } catch (error) {
                console.error('Failed to load pending responses:', error);
            }
        }

        function updatePendingResponsesList(responses) {
            const container = document.getElementById('pendingResponses');
            
            if (responses.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Отложенных ответов нет</p>';
                return;
            }

            const responsesHtml = responses.map(response => {
                const qualityClass = getQualityClass(response.quality_label);
                
                return `
                    <div class="pending-item" data-response-id="${response.id}">
                        <div><strong>Лид:</strong> "${response.lead_message.substring(0, 100)}..."</div>
                        <div><strong>Источник:</strong> ${response.chat_source}</div>
                        <div><strong>Качество:</strong> <span class="lead-quality ${qualityClass}">${response.quality_label}</span></div>
                        <div><strong>ИИ ответ:</strong></div>
                        <textarea class="response-text" data-original="${response.ai_response}">${response.edited_response || response.ai_response}</textarea>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-success" onclick="approveResponse(${response.id})">✅ Отправить</button>
                            <button class="btn btn-warning" onclick="editResponse(${response.id})">✏️ Редактировать</button>
                            <button class="btn btn-danger" onclick="rejectResponse(${response.id})">❌ Отклонить</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = responsesHtml;
        }

        async function approveResponse(responseId) {
            try {
                await apiRequest('/api/response-action', {
                    method: 'POST',
                    body: JSON.stringify({
                        response_id: responseId,
                        action: 'approve'
                    })
                });
                
                const item = document.querySelector(`[data-response-id="${responseId}"]`);
                if (item) {
                    item.style.background = '#d4edda';
                    item.querySelector('.btn-success').textContent = '✅ Отправлено';
                    item.querySelector('.btn-success').disabled = true;
                }
                
                showNotification('Ответ отправлен', 'success');
            } catch (error) {
                showNotification('Ошибка отправки ответа', 'error');
            }
        }

        async function rejectResponse(responseId) {
            try {
                await apiRequest('/api/response-action', {
                    method: 'POST',
                    body: JSON.stringify({
                        response_id: responseId,
                        action: 'reject'
                    })
                });
                
                const item = document.querySelector(`[data-response-id="${responseId}"]`);
                if (item) {
                    item.style.background = '#f8d7da';
                    item.querySelector('.btn-danger').textContent = '❌ Отклонено';
                    item.querySelector('.btn-danger').disabled = true;
                }
                
                showNotification('Ответ отклонен', 'warning');
            } catch (error) {
                showNotification('Ошибка отклонения ответа', 'error');
            }
        }

        async function editResponse(responseId) {
            const item = document.querySelector(`[data-response-id="${responseId}"]`);
            const textarea = item.querySelector('.response-text');
            
            textarea.focus();
            textarea.style.borderColor = '#667eea';
            
            // Сохраняем отредактированный текст
            const editedText = textarea.value;
            
            try {
                await apiRequest('/api/response-action', {
                    method: 'POST',
                    body: JSON.stringify({
                        response_id: responseId,
                        action: 'edit',
                        edited_text: editedText
                    })
                });
                
                showNotification('Ответ отредактирован', 'info');
            } catch (error) {
                showNotification('Ошибка редактирования ответа', 'error');
            }
        }

        // Аналитика и графики
        function initializeCharts() {
            // График качества лидов
            const leadQualityCtx = document.getElementById('leadQualityChart');
            if (leadQualityCtx) {
                charts.leadQuality = new Chart(leadQualityCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'],
                        datasets: [{
                            label: '🔥 Горячие',
                            data: [12, 19, 15, 25, 22, 18, 23],
                            borderColor: '#ff4757',
                            backgroundColor: 'rgba(255, 71, 87, 0.1)',
                            tension: 0.4
                        }, {
                            label: '🟡 Хорошие',
                            data: [18, 25, 22, 30, 28, 25, 32],
                            borderColor: '#ffa502',
                            backgroundColor: 'rgba(255, 165, 2, 0.1)',
                            tension: 0.4
                        }, {
                            label: '🟢 Обычные',
                            data: [25, 30, 28, 35, 32, 30, 38],
                            borderColor: '#2ed573',
                            backgroundColor: 'rgba(46, 213, 115, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // График эффективности ответов
            const responseEfficiencyCtx = document.getElementById('responseEfficiencyChart');
            if (responseEfficiencyCtx) {
                charts.responseEfficiency = new Chart(responseEfficiencyCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Отвечено автоматически', 'Отвечено вручную', 'Не отвечено'],
                        datasets: [{
                            data: [156, 23, 12],
                            backgroundColor: ['#667eea', '#2ed573', '#ff4757']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
        }

        async function loadAnalytics() {
            try {
                const analytics = await apiRequest('/api/analytics');
                updateCharts(analytics);
            } catch (error) {
                console.error('Failed to load analytics:', error);
            }
        }

        function updateCharts(analytics) {
            // Обновляем графики с реальными данными
            if (charts.leadQuality && analytics.weekly_leads) {
                // Здесь можно обновить данные графика
                charts.leadQuality.update();
            }
            
            if (charts.responseEfficiency && analytics.response_efficiency) {
                charts.responseEfficiency.data.datasets[0].data = [
                    analytics.response_efficiency.responded,
                    0, // Ручные ответы (пока не реализовано)
                    analytics.response_efficiency.not_responded
                ];
                charts.responseEfficiency.update();
            }
        }

        // Экспорт данных

        async function exportData() {
            const period = document.getElementById('exportPeriod').value;
            const format = document.getElementById('exportFormat').value;
            
            try {
                showNotification('Подготовка экспорта...', 'info');
                
                // Получаем данные с сервера
                const response = await fetch(`/api/leads?limit=1000`);
                const leads = await response.json();
                
                // Фильтруем по периоду
                const now = new Date();
                const daysAgo = new Date(now.getTime() - (period * 24 * 60 * 60 * 1000));
                
                const filteredLeads = leads.filter(lead => {
                    const leadDate = new Date(lead.timestamp);
                    return leadDate >= daysAgo;
                });
                
                if (filteredLeads.length === 0) {
                    showNotification('Нет данных за выбранный период', 'warning');
                    return;
                }
                
                // Форматируем данные для экспорта
                const exportData = filteredLeads.map(lead => ({
                    'ID': lead.id,
                    'Дата и время': lead.timestamp,
                    'Источник': lead.chat_source,
                    'Имя чата': lead.chat_name || 'Неизвестно',
                    'Отправитель': lead.sender_name,
                    'Сообщение': lead.message_text,
                    'Качество': lead.quality_label,
                    'Оценка': lead.quality_score,
                    'Причины': Array.isArray(lead.quality_reasons) ? lead.quality_reasons.join(', ') : '',
                    'Ответ отправлен': lead.responded ? 'Да' : 'Нет'
                }));
                
                // Генерируем имя файла
                const dateStr = now.toISOString().split('T')[0];
                const periodName = period == 1 ? 'today' : `${period}days`;
                const filename = `leads_${periodName}_${dateStr}`;
                
                // Экспортируем в выбранном формате
                if (format === 'xlsx') {
                    exportToExcel(exportData, filename);
                } else if (format === 'csv') {
                    exportToCSV(exportData, filename);
                } else if (format === 'json') {
                    exportToJSON(exportData, filename);
                }
                
                showNotification(`✅ Экспорт ${filteredLeads.length} лидов завершен!`, 'success');
                
            } catch (error) {
                console.error('Ошибка экспорта:', error);
                showNotification('Ошибка экспорта данных', 'error');
            }
        }

        function exportToExcel(data, filename) {
            // Создаем новую книгу
            const wb = XLSX.utils.book_new();
            
            // Конвертируем данные в лист
            const ws = XLSX.utils.json_to_sheet(data);
            
            // Настраиваем ширину колонок
            const colWidths = [
                { wch: 8 },   // ID
                { wch: 20 },  // Дата и время
                { wch: 25 },  // Источник
                { wch: 25 },  // Имя чата
                { wch: 20 },  // Отправитель
                { wch: 50 },  // Сообщение
                { wch: 20 },  // Качество
                { wch: 10 },  // Оценка
                { wch: 40 },  // Причины
                { wch: 15 }   // Ответ отправлен
            ];
            ws['!cols'] = colWidths;
            
            // Добавляем лист в книгу
            XLSX.utils.book_append_sheet(wb, ws, 'Лиды');
            
            // Добавляем сводку на второй лист
            const summary = [
                { 'Параметр': 'Всего лидов', 'Значение': data.length },
                { 'Параметр': 'Горячие лиды', 'Значение': data.filter(l => l['Качество'].includes('ГОРЯЧИЙ')).length },
                { 'Параметр': 'Хорошие лиды', 'Значение': data.filter(l => l['Качество'].includes('ХОРОШИЙ')).length },
                { 'Параметр': 'Обычные лиды', 'Значение': data.filter(l => l['Качество'].includes('ОБЫЧНЫЙ')).length },
                { 'Параметр': 'Низкое качество', 'Значение': data.filter(l => l['Качество'].includes('НИЗКОЕ')).length },
                { 'Параметр': 'Отвечено', 'Значение': data.filter(l => l['Ответ отправлен'] === 'Да').length },
                { 'Параметр': 'Без ответа', 'Значение': data.filter(l => l['Ответ отправлен'] === 'Нет').length }
            ];
            
            const ws2 = XLSX.utils.json_to_sheet(summary);
            ws2['!cols'] = [{ wch: 20 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, ws2, 'Сводка');
            
            // Сохраняем файл
            XLSX.writeFile(wb, `${filename}.xlsx`);
        }

        function exportToCSV(data, filename) {
            // Создаем CSV контент
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row =>
                    headers.map(header => {
                        const value = row[header];
                        // Экранируем запятые и кавычки
                        const escaped = String(value).replace(/"/g, '""');
                        return escaped.includes(',') || escaped.includes('"') || escaped.includes('\n')
                            ? `"${escaped}"`
                            : escaped;
                    }).join(',')
                )
            ].join('\n');
            
            // Создаем Blob с BOM для корректного отображения в Excel
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // Скачиваем файл
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${filename}.csv`;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        function exportToJSON(data, filename) {
            // Создаем красиво отформатированный JSON
            const jsonContent = JSON.stringify(data, null, 2);
            
            // Создаем Blob
            const blob = new Blob([jsonContent], { type: 'application/json' });
            
            // Скачиваем файл
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${filename}.json`;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        // Показ уведомлений
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Периодическое обновление данных
        setInterval(() => {
            if (currentSection === 'overview') {
                refreshData();
            }
        }, 30000); // Каждые 30 секунд

        // Автозагрузка данных при переключении разделов
        function autoLoadSectionData() {
            setInterval(() => {
                switch(currentSection) {
                    case 'responses':
                        loadPendingResponses();
                        break;
                    case 'analytics':
                        loadAnalytics();
                        break;
                }
            }, 60000); // Каждую минуту
        }

        // Запускаем автообновление
        autoLoadSectionData();
        
        async function generateQuickStats() {
            try {
                const response = await fetch('/api/status');
                const stats = await response.json();
                
                document.getElementById('quickStats').innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <strong>Всего лидов:</strong> ${stats.total_leads || 0}
                        </div>
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <strong>Горячих лидов:</strong> ${stats.hot_leads || 0}
                        </div>
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <strong>Отвечено:</strong> ${stats.responded || 0}
                        </div>
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <strong>Процент ответов:</strong> ${stats.response_rate || 0}%
                        </div>
                    </div>
                `;
                
                showNotification('Статистика обновлена', 'success');
            } catch (error) {
                showNotification('Ошибка загрузки статистики', 'error');
            }
        }
        
        // Поиск лидов
        async function scanLeads() {
            try {
                showNotification('Запуск сканирования лидов...', 'info');
                
                const result = await apiRequest('/api/scan-leads', {
                    method: 'POST'
                });
                
                if (result.status === 'success') {
                    showNotification('Сканирование запущено! Проверьте консоль сервера', 'success');
                    
                    // Обновляем данные через 30 секунд
                    setTimeout(() => {
                        refreshData();
                        loadKeywords();
                    }, 30000);
                } else {
                    showNotification('Ошибка запуска сканирования', 'error');
                }
            } catch (error) {
                showNotification('Ошибка соединения при сканировании', 'error');
            }
        }
    </script>
</body>
</html>
